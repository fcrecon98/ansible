## 2016/06/24 : morihaya : Created for CentOS5 servers of MHF

# 外部との許可でハマったのでrepo登録してyumで落とす方法は辞めた
#- name: copy repository file
# action: copy src=treasuredata.repo dest=/etc/yum.repos.d/
#  tags:
#    - td-agent
#
#- name: install td-agent
#  action: yum name={{ item }} state=latest enablerepo=treasuredata
#  with_items:
#    - td-agent
#    - libcurl-devel
#  tags:
#    - td-agent


- name: copy source file
  copy: src={{ item }} dest=/usr/local/src
  with_items:
    - td-agent-2.3.1-0.el5.x86_64.rpm
    - GPG-KEY-td-agent
  tags:
    - td-agent

# 警告がでてエラーになるので先にGPGをインストール
- name: import GPG key for td-agent
  shell: rpm --import /usr/local/src/{{ item }}
  with_items:
    - GPG-KEY-td-agent
  tags:
    - td-agent

- name: install packages
  yum: name=/usr/local/src/{{ item }} state=present
  with_items:
    - td-agent-2.3.1-0.el5.x86_64.rpm
  tags:
    - td-agent

# confの位置を修正
- name: create conf directory
 #action: file dest=/etc/td-agent/td-agent.conf.d/ state=directory
  action: file dest=/etc/td-agent/config.d/ state=directory
  tags:
    - td-agent

- name: create pos directory
  action: file dest=/var/log/td-agent/pos/ state=directory owner=td-agent group=td-agent
  tags:
    - td-agent

- name: create err directory
  action: file dest=/var/log/td-agent/err/ state=directory owner=td-agent group=td-agent mode=0777
  tags:
    - td-agent

- name: create buffer directory
  action: file dest=/tmp/td-agent/buffer/ state=directory owner=td-agent group=td-agent mode=0777
  tags:
    - td-agent

- name: create forward-failed directory
  action: file dest=/var/log/td-agent/forward-failed state=directory owner=td-agent group=td-agent mode=0777
  tags:
    - td-agent

- name: copy base td-agent conf file
  action: copy src=td-agent.conf dest=/etc/td-agent/td-agent.conf backup=yes
  tags:
    - td-agent

- name: install plugins
  action: shell http_proxy={{ http_proxy }} td-agent-gem install {{ item }}
  with_items:
#    - fluent-plugin-tail-ex  # Deprecated: Fluentd has the features of this plugin since 0.10.45.
    - fluent-plugin-file-alternative
#    - fluent-plugin-parser   # in fluentd v0.12 or later, ParserFilter is recommended for simple configuartion and better performance.
#    - fluent-plugin-filter   # In fluentd >= 0.12, we can use `filter` declarative. So release Filter filter:
    - fluent-plugin-forest 
    - fluent-plugin-mongo
    - fluent-plugin-elasticsearch
    - fluent-plugin-multi-format-parser
    - fluent-plugin-remote_syslog
    - fluent-plugin-rewrite
  tags:
    - td-agent

# confの位置を修正
- name: copy monitor.conf to /etc/td-agent/td-agent.conf.d/
  #action: copy src=monitor.conf dest=/etc/td-agent/td-agent.conf.d/
  action: copy src=monitor.conf dest=/etc/td-agent/config.d/
  tags:
    - td-agent

- name: start td-agent service
  action: service name=td-agent state=restarted
  tags:
    - td-agent

