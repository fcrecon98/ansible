#user parameter for monitoring multipath paths#

#
# Description: Discover multipath device aliases
# Key: multipath.alias.discovery
# Type of information: text
# Example: multipath.alias.discovery [t|{"data":[{"{#ALIAS}":"mpath0"}]}]
# Note: require '/opt/capcom/zabbix/multipath-ll-v1.dat'
#       put this cron entry under /etc/cron.d/monitor-multipath
#       * * * * * root /sbin/multipath -ll -v1 > /opt/capcom/zabbix/multipath-ll-v1.dat
#

UserParameter=multipath.device.discovery,/bin/awk 'BEGIN{printf "{\"data\":["}{sub(/^[a-z]+:/,"",$1);{printf c"{\"{#ALIAS}\":\""$1"\"}";c=","}}END{printf "]}"}' /opt/capcom/zabbix/multipath-ll-v1.dat

#
# Description: Get specific detail of multipath device
# Key: multipath.device.<ITEM>[<ALIAS>]
# Type of information: mutual
# Example: multipath.device.wwn[mpath0]
# Note: require '/opt/capcom/zabbix/multipath-ll-v2.dat'
#       put this cron entry under /etc/cron.d/monitor-multipath
#       * * * * * root for ALIAS in `cat /opt/capcom/zabbix/multipath-ll-v1.dat`;do /sbin/multipath -ll ${ALIAS} > /opt/capcom/zabbix/multipath-ll-v2.${ALIAS}.dat;done
#
UserParameter=multipath.device.wwn[*],/usr/bin/head -2 /opt/capcom/zabbix/multipath-ll-v2.$1.dat | xargs | sed -e 's/\]/ /g' | sed -e 's/\[/ /g' | sed -e 's/[(|)]//g' | awk '{print $$2}'
UserParameter=multipath.device.name[*],/usr/bin/head -2 /opt/capcom/zabbix/multipath-ll-v2.$1.dat | xargs | sed -e 's/\]/ /g' | sed -e 's/\[/ /g' | sed -e 's/[(|)]//g' | awk '{print $$3}'
UserParameter=multipath.device.type[*],/usr/bin/head -2 /opt/capcom/zabbix/multipath-ll-v2.$1.dat | xargs | sed -e 's/\]/ /g' | sed -e 's/\[/ /g' | sed -e 's/[(|)]//g' | awk '{print $$4}'
UserParameter=multipath.device.size[*],/usr/bin/head -2 /opt/capcom/zabbix/multipath-ll-v2.$1.dat | xargs | sed -e 's/\]/ /g' | sed -e 's/\[/ /g' | sed -e 's/[(|)]//g' | awk '{print $$5}' | awk -F '=' '{print $$2}' | sed -e 's/G/000000000/'
UserParameter=multipath.device.options[*],/usr/bin/head -2 /opt/capcom/zabbix/multipath-ll-v2.$1.dat | xargs | sed -e 's/\]/ /g' | sed -e 's/\[/ /g' | sed -e 's/[(|)]//g' | awk '{for (i=6;i<NF;i++){printf("%s%s",$$i,OFS=" ")}print $$NF}'
UserParameter=multipath.device.numberofpath[*],/bin/grep \: /opt/capcom/zabbix/multipath-ll-v2.$1.dat | wc -l
UserParameter=multipath.device.numberofactivepath[*],/bin/grep \: /opt/capcom/zabbix/multipath-ll-v2.$1.dat | awk '{if ($$5=="[active][ready]") print $$0}' | wc -l
UserParameter=multipath.device.numberoffaultypath[*],/bin/grep \: /opt/capcom/zabbix/multipath-ll-v2.$1.dat | awk '{if ($$5=="[active][faulty]") print $$0}' | wc -l

#
# Description: Discover paths together with their multipath aliases
# Key: multipath.path.discovery
# Type of information: text
# Example: multipath.path.discovery [t|{"data":[{"{#ALIAS}":"mpath0","{#PATH}":"sda"}]}]
# Note: require '/opt/capcom/zabbix/multipath-ll-v2.dat'
#       put this cron entry under /etc/cron.d/monitor-multipath
#       * * * * * root /sbin/multipath -ll -v2 > /opt/capcom/zabbix/multipath-ll-v2.dat
#
UserParameter=multipath.path.discovery,/bin/awk 'BEGIN{printf "{\"data\":["}{sub(/^[a-z]+:/,"",$1);if($1~/^[[:alnum:]]+$/) m=$1;if(/^ \\_/){printf c"{\"{#ALIAS}\":\""m"\",\"{#PATH}\":\""$3"\"}";c=","}}END{printf "]}"}' /opt/capcom/zabbix/multipath-ll-v2.dat

#
# Description: Get specific detail of multipath path
# Key: multipath.path.<ITEM>[<ALIAS>,<PATH>]
# Type of information: text
# Example: multipath.path.priority[<ALIAS>,<PATH>]
# Note: require '/opt/capcom/zabbix/multipath-ll-v2.dat'
#       put this cron entry under /etc/cron.d/monitor-multipath
#       * * * * * root for ALIAS in `cat /opt/capcom/zabbix/multipath-ll-v1.dat`;do /sbin/multipath -ll ${ALIAS} > /opt/capcom/zabbix/multipath-ll-v2.${ALIAS}.dat;done
#
UserParameter=multipath.path.mode[*],/bin/grep -B100 $2 /opt/capcom/zabbix/multipath-ll-v2.$1.dat | /bin/grep prio | /usr/bin/tail -1 | awk '{print $$2}'
UserParameter=multipath.path.priority[*],/bin/grep -B100 $2 /opt/capcom/zabbix/multipath-ll-v2.$1.dat | /bin/grep prio | /usr/bin/tail -1 | sed -e 's/]/ /g' | sed -e 's/\[/ /g' | awk '{print $$(NF-1)}' | awk -F'=' '{print $$2}'
UserParameter=multipath.path.groupstatus[*],/bin/grep -B100 $2 /opt/capcom/zabbix/multipath-ll-v2.$1.dat | /bin/grep prio | /usr/bin/tail -1 | sed -e 's/]/ /g' | sed -e 's/\[/ /g' | awk '{print $$NF}'
UserParameter=multipath.path.scsihostnumber[*],/bin/grep $2 /opt/capcom/zabbix/multipath-ll-v2.$1.dat | awk '{print $$2}'
UserParameter=multipath.path.devicenumber[*],/bin/grep $2 /opt/capcom/zabbix/multipath-ll-v2.$1.dat | awk '{print $$4}'
UserParameter=multipath.path.multipathstatus[*],/bin/grep $2 /opt/capcom/zabbix/multipath-ll-v2.$1.dat | awk '{print $$5}' | sed 's/]/ /g' | sed 's/\[//g' | awk '{print $$1}'
UserParameter=multipath.path.pathstatus[*],/bin/grep $2 /opt/capcom/zabbix/multipath-ll-v2.$1.dat | awk '{print $$5}' | sed 's/]/ /g' | sed 's/\[//g' | awk '{print $$NF}'
